from code.sfml_plus import Window
from code.sfml_plus import key

#########################################

from sfml import Text, Font
from sfml import Color
from sfml import KeyEvent

from sfml import VertexArray, PrimitiveType
from sfml import Clock

from sfml import RectangleShape
from code.sfml_plus import Rectangle

class TextBox(Rectangle):
# * May have text inputted with a keyboard.
# * Box has a flickering cursor.
# WIP - Box is bounded.
# WIP - Only responds when highlighted.
# WIP - A UI element. May be added to a UI box.

	def __init__(self):
		self._create_font()
		self._create_text()
		self.cursor = self.cursor()

	def controls(self, window, key):
		self._input(window, key)

	def draw(self, window, camera):
		self._create_rectangle()
		window.draw(self.rectangle)

		window.draw(self.text)

		self.cursor.create(self.text)
		window.draw(self.cursor.line)


	#####
	# RECTANGLE

	padding = 2
	@property
	def x(self): return self.text.position[0]-self.padding
	@property
	def y(self): return self.text.position[1]-self.padding
	@property
	def w(self): return 100 + self.padding
	@property
	def h(self):
		return self.text.character_size + 2 + self.padding


	###
	#GRAPHICS

	font = None
	def _create_font(self): #init
		d = "assets/fonts/PIXEARG_.ttf"
		font = Font.from_file(d)
		self.font = font
		self.font.get_texture(8).smooth = False

	text = None
	string = None
	def _create_text(self, string=""): #init, input
		text = Text(string)
		text.font = self.font
		text.character_size = 8
		text.style = Text.REGULAR
		text.color = Color.BLACK
		text.position = 100,100
		self.text = text
		self.string = string


	#

	class cursor:
		line = None
		
		def create(self, text): #draw
			line = VertexArray(PrimitiveType.LINES, 2)

			self._flicker()
			if self.flicker:
				x, y, w, h = text.global_bounds

				line[0].position = (x+w,y)
				line[1].position = (x+w,y+h)

				line[0].color = Color.BLACK
				line[1].color = Color.BLACK
			self.line = line


		# Flicker the cursor.
		clock = Clock()
		flicker = False
		def _flicker(self): #create
			if self.clock.elapsed_time.seconds > 0.5:
				self.flicker = not self.flicker
				self.clock.restart()


	rectangle = None
	def _create_rectangle(self): #draw
		rectangle = RectangleShape((10,10))

		rectangle.position = self.position
		rectangle.size = self.size

		rectangle.outline_color = Color.BLACK
		rectangle.outline_thickness = 1

		self.rectangle = rectangle

	###

	def _input(self, window, key): #controls
		def add_chr(key_chr):
			self.string += key_chr
			self._create_text(self.string)

		def remove_chr():
			if len(self.string) >= 1:
				self.string = self.string[:-1]
				self._create_text(self.string)

		if window.key_pressed:
			key_chr = str(window.key_pressed)

			if key_chr.isalpha() and len(key_chr) == 1:
				if key.L_SHIFT.held():
					add_chr(key_chr.upper())
				else:
					add_chr(key_chr.lower())

				#Can't exceed box length.
				w = self.text.global_bounds.width
				if w+2 > self.w:
					remove_chr()
				#

			if key_chr == "BACKSPACE":
				remove_chr()
			if key_chr == "SPACE":
				add_chr(" ")

#########################################

textbox1 = TextBox() #

window = Window((1200,600), "Pop-up Boxes")
from code.sfml_plus import Camera
Camera = Camera(window)
# Camera.zoom = 2
Camera.position = 0,0


while window.is_open:
	if window.is_focused:
		if key.ENTER.pressed(): print textbox1.string
		textbox1.controls(window, key) #


	window.view = Camera
	window.clear((255,255,255))
	textbox1.draw(window, None) #
	window.display()